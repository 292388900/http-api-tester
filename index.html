<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>接口测试工具</title>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

	<style>
	@charset "utf-8";
	/* CSS Document */
	.jf-ObjectBrace {
		color: #00AA00;
		font-weight: bold;
	}
	.jf-ArrayBrace {
		color: #0033FF;
		font-weight: bold;
	}
	.jf-PropertyName {
		color: #CC0000;
		font-weight: bold;
	}
	.jf-String {
		color: #007777;
	}
	.jf-Number {
		color: #AA00AA;
	}
	.jf-Boolean {
		color: #0000FF;
	}
	.jf-Null {
		color: #0000FF;
	}
	.jf-Comma {
		color: #000000;
		font-weight: bold;
	}
	pre.jf-CodeContainer {
		margin-top: 0;
		margin-bottom: 0;
		text-align: left;
	}
	</style>

    </head>

    <body>
        <div class="container">
            <hr />
            <div class="panel panel-default">
                <div class="panel-heading">
                    <form class="form-inline" onsubmit="return onSubmit();">
                        <div class="form-group">
                            <label for="method">请求方式：</label>
                            <input type="radio" name="method" id="method_get" value="get" /><label for="method_get">GET</label>&nbsp;
                            <input type="radio" name="method" id="method_post" value="post" checked="checked" /><label for="method_post">POST</label>
                        </div>
                        <div class="form-group" style="margin-left: 1em; margin-right: 1em;">
                            <label for="url">URL：</label>
                            <input type="text" name="url" id="url" class="form-control" placeholder="http://" style="width: 20em;" >
                        </div>
                        <div class="form-group" style="margin-left: 1em; margin-right: 1em;">
                            <label>压测：</label>
                            <label for="boom_n">次数</label>
                            <input type="number" name="boom_n" id="boom_n" class="form-control" value="100" style="width: 5em;">
                            <label for="boom_c">并发数</label>
                            <input type="number" name="boom_c" id="boom_c" class="form-control" value="10"  style="width: 5em;">
                        </div>                        
                        <button type="submit" class="btn btn-default">测试HTTP接口</button>
                        <button type="button" class="btn btn-default" id="addArgBtn">添加参数</button>
                        <hr />
                        <div class="form-group">
                            <label for="api_sign_key">密钥名称：</label>
                            <input type="text" name="api_sign_key" id="api_sign_key" value="api_sign" class="form-control">
                        </div>
                        <div class="form-group" style="margin-left: 1em; margin-right: 1em;">
                            <label for="api_secret">密码：</label>
                            <input type="text" name="api_secret" id="api_secret" value="" class="form-control">
                        </div>
                        <b>接口测试工具自动生成密钥</b>
                    </form>
                </div>
                <div class="panel-body">
                    <table class="table table-bordered" id="table_args">
                    </table>
                </div>
                <div id="resultPanel" class="panel-footer">
                </div>
            </div>
        </div>
    </body>

    <script src="http://cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <script src="http://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

    <script type="text/javascript" charset="utf-8">

		function JsonFormater(opt) {
			this.options = $.extend({
				dom: '',
				tabSize: 2,
				singleTab: "  ",
				quoteKeys: true,
				imgCollapsed: "data:image/gif;base64,R0lGODlhHAALAMQAAP////7++/z8/Pb29fb18PHx7e/w6/Hw6e3s5unp4+jm2ODg3t3a0dnVy9bQxtLMv8zJurDC1L+9sMK4p32buDMzMwAAAP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEHABcALAAAAAAcAAsAAAVU4CWOZGmeV0StLBWhsEgBdA1QMUwJvMUTuNyJMihaBodFUFiiECxQKGMpqlSq14uVRCkUEJbEokHVZrdmrqLRsDgekDLzQoFIJni8nKlqrV5zgYIhADs=",
				imgExpanded: "data:image/gif;base64,R0lGODlhHAALAMQAAP////7++/z8/Pb29fb18PHx7e/w6/Hw6e3s5unp4+Dg3t3a0djY0dnVy9fTxNbQxtLMv8zJurDC1L+9sMK4p32buAAAAP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEHABcALAAAAAAcAAsAAAVL4CWOZGmel1StbCWhsFgBdA1UMVwJQd8TuNypMigWD4qgsFQhWJ7PhXI5qhQKCERC0ZhSLxUFo+FwQCJeagUyobjd6aWqtXp979QQADs=",
				isCollapsible: true
			}, opt || {});
			this.isFormated = false;
			this.obj = {
				_dateObj: new Date(),
				_regexpObj: new RegExp()
			};
			this.init();
		}
		JsonFormater.prototype = {
			init: function () {
				this.tab = this.multiplyString(this.options.tabSize, this.options.singleTab);
				this.bindEvent();
			},
			doFormat: function (json) {
				var html;
				var obj;
				try {
					if(typeof json == 'object'){
						obj = [json];
					}else{
						if (json == ""){
							json = "\"\"";
						}
						obj = eval("[" + json + "]");
					}
					html = this.ProcessObject(obj[0], 0, false, false, false);
					$(this.options.dom).html("<pre class='jf-CodeContainer'>" + html + "</pre>");
					this.isFormated = true;
				} catch (e) {
					alert("JSON数据格式不正确:\n" + e.message);
					$(this.options.dom).html("");
					this.isFormated = false;

                    var newWindowObi=window.open("出错信息");
                    newWindowObi.document.write(json);
				}
			},
			bindEvent: function () {
				var that = this;
				$(this.options.dom).off('click','.imgToggle');
				$(this.options.dom).on('click', '.imgToggle', function () {
					if (that.isFormated == false) {
						return;
					}
					that.makeContentVisible($(this).parent().next(), !$(this).data('status'));
				});
			},
			expandAll: function () {
				if (this.isFormated == false) {
					return;
				}
				var that = this;
				this.traverseChildren($(this.options.dom), function(element){
					if(element.hasClass('jf-collapsible')){
						that.makeContentVisible(element, true);
					}
				}, 0);
			},
			collapseAll: function () {
				if (this.isFormated == false) {
					return;
				}
				var that = this;
				this.traverseChildren($(this.options.dom), function(element){
					if(element.hasClass('jf-collapsible')){
						that.makeContentVisible(element, false);
					}
				}, 0);
			},
			collapseLevel: function(level){
				if (this.isFormated == false) {
					return;
				}
				var that = this;
				this.traverseChildren($(this.options.dom), function(element, depth){
					if(element.hasClass('jf-collapsible')){
						if(depth >= level){
							that.makeContentVisible(element, false);
						}else{
							that.makeContentVisible(element, true);
						}
					}
				}, 0);

			},
			isArray: function (obj) {
				return  obj &&
					typeof obj === 'object' &&
					typeof obj.length === 'number' && !(obj.propertyIsEnumerable('length'));
			},
			getRow: function (indent, data, isPropertyContent) {
				var tabs = "";
				if (!isPropertyContent) {
					tabs = this.multiplyString(indent, this.tab);
				}
				if (data != null && data.length > 0 && data.charAt(data.length - 1) != "\n") {
					data = data + "\n";
				}
				return tabs + data;
			},
			formatLiteral: function (literal, quote, comma, indent, isArray, style) {
				if (typeof literal == 'string') {
					literal = literal.split("<").join("&lt;").split(">").join("&gt;");
				}
				var str = "<span class='jf-" + style + "'>" + quote + literal + quote + comma + "</span>";
				if (isArray) str = this.getRow(indent, str);
				return str;
			},
			formatFunction: function (indent, obj) {
				var tabs;
				var i;
				var funcStrArray = obj.toString().split("\n");
				var str = "";
				tabs = this.multiplyString(indent, this.tab);
				for (i = 0; i < funcStrArray.length; i++) {
					str += ((i == 0) ? "" : tabs) + funcStrArray[i] + "\n";
				}
				return str;
			},
			multiplyString: function (num, str) {
				var result = '';
				for (var i = 0; i < num; i++) {
					result += str;
				}
				return result;
			},
			traverseChildren: function (element, func, depth) {
				var length = element.children().length;
				for (var i = 0; i < length; i++) {
					this.traverseChildren(element.children().eq(i), func, depth + 1);
				}
				func(element, depth);
			},
			makeContentVisible : function(element, visible){
				var img = element.prev().find('img');
				if(visible){
					element.show();
					img.attr('src', this.options.imgExpanded);
					img.data('status', 1);
				}else{
					element.hide();
					img.attr('src', this.options.imgCollapsed);
					img.data('status', 0);
				}
			},
			ProcessObject: function (obj, indent, addComma, isArray, isPropertyContent) {
				var html = "";
				var comma = (addComma) ? "<span class='jf-Comma'>,</span> " : "";
				var type = typeof obj;
				var clpsHtml = "";
				var prop;
				if (this.isArray(obj)) {
					if (obj.length == 0) {
						html += this.getRow(indent, "<span class='jf-ArrayBrace'>[ ]</span>" + comma, isPropertyContent);
					} else {
						clpsHtml = this.options.isCollapsible ? "<span><img class='imgToggle' data-status='1' src='" + this.options.imgExpanded + "'/></span><span class='jf-collapsible'>" : "";
						html += this.getRow(indent, "<span class='jf-ArrayBrace'>[</span>" + clpsHtml, isPropertyContent);
						for (var i = 0; i < obj.length; i++) {
							html += this.ProcessObject(obj[i], indent + 1, i < (obj.length - 1), true, false);
						}
						clpsHtml = this.options.isCollapsible ? "</span>" : "";
						html += this.getRow(indent, clpsHtml + "<span class='jf-ArrayBrace'>]</span>" + comma);
					}
				} else if (type == 'object') {
					if (obj == null) {
						html += this.formatLiteral("null", "", comma, indent, isArray, "Null");
					} else {
						var numProps = 0;
						for (prop in obj) numProps++;
						if (numProps == 0) {
							html += this.getRow(indent, "<span class='jf-ObjectBrace'>{ }</span>" + comma, isPropertyContent);
						} else {
							clpsHtml = this.options.isCollapsible ? "<span><img class='imgToggle' data-status='1' src='" + this.options.imgExpanded + "'/></span><span class='jf-collapsible'>" : "";
							html += this.getRow(indent, "<span class='jf-ObjectBrace'>{</span>" + clpsHtml, isPropertyContent);
							var j = 0;
							for (prop in obj) {
								var quote = this.options.quoteKeys ? "\"" : "";
								html += this.getRow(indent + 1, "<span class='jf-PropertyName'>" + quote + prop + quote + "</span>: " + this.ProcessObject(obj[prop], indent + 1, ++j < numProps, false, true));
							}
							clpsHtml = this.options.isCollapsible ? "</span>" : "";
							html += this.getRow(indent, clpsHtml + "<span class='jf-ObjectBrace'>}</span>" + comma);
						}
					}
				} else if (type == 'number') {
					html += this.formatLiteral(obj, "", comma, indent, isArray, "Number");
				} else if (type == 'boolean') {
					html += this.formatLiteral(obj, "", comma, indent, isArray, "Boolean");
				}else if (type == 'undefined') {
					html += this.formatLiteral("undefined", "", comma, indent, isArray, "Null");
				} else {
					html += this.formatLiteral(obj.toString().split("\\").join("\\\\").split('"').join('\\"'), "\"", comma, indent, isArray, "String");
				}
				return html;
			}
		};

	</script>


    <script type="text/javascript" charset="utf-8">

    var g_num = 0;
    var submit_url = '/submit';

var arg_tpl = ' <tr class="tr-args"> '+
'<td> <label>参数名：</label> <input type="text" class="form-control arg-keys" style="display: inline; width: 12em;" /> </td> '+
'<td> <label>参数值：</label> <input type="text" class="form-control arg-values" style="display: inline; width: 12em;" /> </td> '+
'<td> <label for="method">参数类型：</label> <input type="radio" name="arg_method_%NUM%" id="arg_method_get_%NUM%" value="get" /><label for="arg_method_get_%NUM%">GET</label>&nbsp; '+
'<input type="radio" name="arg_method_%NUM%" id="arg_method_post_%NUM%" class="arg-method-post" value="post" checked="checked" /><label for="arg_method_post_%NUM%">POST</label> </td> <td> '+
'<button type="button" class="btn btn-default" onclick="removeArg(this)">删除参数</button> </td> </tr> ';

var result_tpl = ' <p><span class="text-danger">执行时间：</span><span class="text-success"> %TIMES% 秒</span></p>'+
'<p><span class="text-danger">状态码：</span><span class="text-success"> %STATUS% </span></p>'+
'<p><span class="text-danger">返回值如下：</span></p>'+
'<hr />'+
'<div id="dataContainer"></div> '+
'<hr />'+
'<p class="text-danger">压测数据：</p>'+
'<pre>%BOOM%</pre>';

var err_tpl = ' <h4 class="text-danger">请求出错！</h4><hr /> <p><span class="text-warning">原因：</span> <span class="text-muted">%MSG%</span> </p> ';

$(function() {

    $("#addArgBtn").click(function() {
        var tpl = arg_tpl.replace(/%NUM%/g, g_num);
        $("#table_args").append(tpl);
        g_num++;
    });

});

function removeArg(btn) {
    $(btn).parent().parent().remove();
}

function onSubmit() {
    var data = {
        "url":      $.trim($("input[name=url]").val()),
        "n":		parseInt($("#boom_n").val()),
        "c":		parseInt($("#boom_c").val()),
        "key":      $.trim($("#api_sign_key").val()),
        "secret":   $.trim($("#api_secret").val()),
        "args":     []
    };

    if (data.url == "") {
        alert("请指定URL地址");
        return false;
    }

	if ($("#method_post").is(":checked")) {
		data.method = "POST";
	} else {
		data.method = "GET";
	}

    $("tr.tr-args").each(function() {
        var key = $(this).find(".arg-keys").val();
        if (key == "") {
            return false;
        }
        var value = $(this).find(".arg-values").val();
        var method = "";
        if ($(this).find(".arg-method-post").is(":checked")) {
            method = "post";
        } else {
            method = "get";
        }
        data.args.push({
            "key":      key,
            "value":    value,
            "method":   method
        });
    });

     console.log("reqeustData", data);

     $("#resultPanel").html("Please wait...");

	$.ajax(submit_url, {
		'data': JSON.stringify(data),
		'type': 'POST',
		'processData': false,
		'contentType': 'application/json',
		'dataType':	'json',
		'success':	function(response) {
			console.log("resultData", response);

			var tpl = '';

			if (response.Status != 200) {
				tpl = err_tpl.replace("%MSG%", response.Msg);
				$("#resultPanel").html(tpl);
				return;
			}

			tpl = result_tpl.replace("%STATUS%", response.Data.Status);
			tpl = tpl.replace("%TIMES%", response.Data.Times);
			tpl = tpl.replace("%BOOM%", response.Data.Boom);
			$("#resultPanel").html(tpl);

			var options = {
				dom : '#dataContainer' //对应容器的css选择器
			};
			var jf = new JsonFormater(options); //创建对象
			jf.doFormat(response.Data.Data); //格式化json

		},
		'error':	function (XMLHttpRequest, textStatus, errorThrown) {
			console.log("errorData", errorThrown);
			alert(textStatus);
		}
	});

     return false;
}

    </script>
</html>
